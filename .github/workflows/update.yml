name: Update all data

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: "40 * * * *"

jobs:
  pre_check:
    runs-on: ubuntu-latest
    # Map a step output to a job output
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@master
        with:
          concurrent_skipping: "always"
          skip_after_successful_duplicate: "false"
          do_not_skip: "[]"

  build:
    runs-on: ubuntu-latest
    needs: pre_check
    if: ${{ needs.pre_check.outputs.should_skip != 'true' }}
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: "azexbot"
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Load cache
        uses: actions/cache@v3
        with:
          key: azex-dbcache-${{ github.run_id }}
          path: "cache"
          restore-keys: |
            azex-dbcache

      - name: Checkout target repo
        uses: actions/checkout@v3
        with:
          path: "output"

      - name: Update json data
        env:
          IMAGE_NAME: ghcr.io/azurlanetools/azex/azex-json
        run: >
          docker run --rm --name azex-json
          -e AZEX_USER=$(id -u):$(id -g)
          -v $PWD:/azex
          $IMAGE_NAME

      - name: Save changes
        run: |
          # push
          cd output
          git push
